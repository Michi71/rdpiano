/*
  ==============================================================================

    phaser.h
    Created: 12 Jul 2025 9:04:50pm
    Author:  Giulio Zausa

  ==============================================================================
*/

#pragma once

#include <cmath>
#include <stdint.h>

static constexpr int32_t phaserRateTable[] = {
    26,   52,   78,   104,  131,  157,  183,  209,  235,  262,  288,  314,
    340,  367,  393,  419,  445,  471,  498,  524,  550,  576,  602,  629,
    655,  681,  707,  734,  760,  786,  812,  838,  865,  891,  917,  943,
    969,  996,  1022, 1048, 1074, 1101, 1127, 1153, 1179, 1205, 1232, 1258,
    1284, 1310, 1336, 1363, 1389, 1415, 1441, 1468, 1494, 1520, 1546, 1572,
    1599, 1625, 1651, 1677, 1703, 1730, 1756, 1782, 1808, 1835, 1861, 1887,
    1913, 1939, 1966, 1992, 2018, 2044, 2070, 2097, 2123, 2149, 2175, 2202,
    2228, 2254, 2280, 2306, 2333, 2359, 2385, 2411, 2437, 2464, 2490, 2516,
    2542, 2569, 2595, 2621, 2673, 2726, 2778, 2831, 2883, 2936, 2988, 3040,
    3093, 3145, 3198, 3250, 3303, 3355, 3407, 3460, 3512, 3565, 3617, 3670,
    3932, 4194, 4456, 4718, 4980, 5242, 5242, 5242,
};

static constexpr int32_t phaserDepthTable[] = {
    0,     139,   279,   419,   561,   703,   846,   989,   1134,  1279,  1425,
    1572,  1720,  1868,  2018,  2168,  2319,  2470,  2623,  2776,  2930,  3086,
    3242,  3398,  3556,  3714,  3874,  4034,  4195,  4357,  4520,  4684,  4849,
    5014,  5181,  5348,  5516,  5686,  5856,  6027,  6199,  6372,  6546,  6721,
    6897,  7073,  7251,  7430,  7610,  7790,  7972,  8155,  8338,  8523,  8709,
    8895,  9083,  9272,  9462,  9653,  9844,  10037, 10231, 10426, 10623, 10820,
    11018, 11217, 11418, 11619, 11822, 12026, 12231, 12437, 12644, 12852, 13061,
    13272, 13484, 13696, 13910, 14126, 14342, 14559, 14778, 14998, 15219, 15442,
    15665, 15890, 16116, 16343, 16572, 16801, 17032, 17265, 17498, 17733, 17969,
    18207, 18445, 18685, 18927, 19169, 19413, 19658, 19905, 20153, 20402, 20653,
    20905, 21159, 21414, 21670, 21927, 22186, 22447, 22709, 22972, 23237, 23503,
    23771, 24040, 24311, 24583, 24856, 25131, 25408};

static constexpr int32_t phaserResonanceTable[] = {
    0,   1,   1,   2,   3,   3,   4,   4,  5,  6,  6,   7,   8,   8,   9,
    10,  10,  11,  12,  12,  13,  14,  15, 15, 16, 17,  17,  18,  19,  20,
    20,  21,  22,  22,  23,  24,  25,  26, 26, 27, 28,  29,  29,  30,  31,
    32,  33,  33,  34,  35,  36,  37,  37, 38, 39, 40,  41,  42,  42,  43,
    44,  45,  46,  47,  48,  49,  49,  50, 51, 52, 53,  54,  55,  56,  57,
    58,  59,  60,  60,  61,  62,  63,  64, 65, 66, 67,  68,  69,  70,  71,
    72,  73,  74,  75,  76,  77,  79,  80, 81, 82, 83,  84,  85,  86,  87,
    88,  89,  90,  92,  93,  94,  95,  96, 97, 98, 100, 101, 102, 103, 104,
    105, 107, 108, 109, 110, 112, 113, 114};

class Phaser {
public:
  void process();
  void reset();

  int32_t audioInL;
  int32_t audioInR;
  int32_t audioOutL;
  int32_t audioOutR;

  int32_t rate;
  int32_t depth;
  int32_t resonance;

private:
  int32_t accA;
  uint8_t bufferPos;
  int32_t iram[0x200];
  int32_t multiplCoef1;
  int32_t multiplCoef2;

  inline void writeMemOffs(uint8_t memOffs, int32_t value) {
    uint32_t ramPos = ((uint32_t)memOffs + bufferPos) & 0x7f;
    iram[ramPos] = value;
  }
  inline int64_t readMemOffs(uint8_t memOffs) {
    uint32_t ramPos = ((uint32_t)memOffs + bufferPos) & 0x7f;
    return iram[ramPos];
  }
};
